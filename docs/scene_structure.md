# MG-0004 카페 매치 타이쿤 - 씬 구성 및 플로우

> **작성일**: 2025-12-17
> **목적**: Match-3 + 경영 시뮬레이션 게임의 씬 구조와 전환 플로우 정의

---

## 목차

1. [씬 아키텍처 개요](#1-씬-아키텍처-개요)
2. [씬 목록 및 계층](#2-씬-목록-및-계층)
3. [씬 전환 플로우](#3-씬-전환-플로우)
4. [씬별 상세 구성](#4-씬별-상세-구성)
5. [Match-3 퍼즐 메커니즘](#5-match-3-퍼즐-메커니즘)
6. [카페 인테리어 시스템](#6-카페-인테리어-시스템)

---

## 1. 씬 아키텍처 개요

### 1.1 게임 구조

```
┌─────────────────────────────────────────────────────────────────┐
│              카페 매치 타이쿤 게임 구조                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [듀얼 코어 시스템]                                             │
│  ┌──────────────────┐          ┌──────────────────┐            │
│  │ Match-3 퍼즐     │  ←────→  │ 카페 경영         │            │
│  │ (스테이지 플레이) │   보상    │ (인테리어/스토리) │            │
│  └──────────────────┘          └──────────────────┘            │
│          │                              │                      │
│          │                              │                      │
│    별/코인 획득                    별/코인 소비                 │
│          │                              │                      │
│          └──────────────┬───────────────┘                      │
│                         │                                      │
│                    메타 진행                                   │
│                  (레벨, 스토리)                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 씬 분류

```
┌─────────────────────────────────────────────────────────────────┐
│                      씬 아키텍처                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [레벨 1] 앱 루트                                               │
│      └── SplashScene                                            │
│                                                                 │
│  [레벨 2] 온보딩                                                │
│      ├── TutorialPuzzleScene (Match-3 튜토리얼)                 │
│      └── TutorialCafeScene (카페 튜토리얼)                      │
│                                                                 │
│  [레벨 3] 메인 게임 (듀얼 탭)                                   │
│      ├── CafeScene (카페 메인)                                  │
│      └── MapScene (스테이지 맵)                                 │
│                                                                 │
│  [레벨 4] 퍼즐 플레이                                           │
│      ├── PuzzleScene (Match-3 게임플레이)                       │
│      ├── PuzzleResultScene (클리어/실패 결과)                   │
│      └── PuzzlePreScene (스테이지 정보)                         │
│                                                                 │
│  [레벨 5] 카페 관리                                             │
│      ├── DecorationScene (인테리어 배치)                        │
│      ├── StoryScene (단골 대화)                                 │
│      └── ShopScene (가구/아이템 구매)                           │
│                                                                 │
│  [레벨 6] 모달/팝업                                             │
│      ├── BoosterSelectModal (부스터 선택)                       │
│      ├── SettingsModal (설정)                                  │
│      ├── HeartModal (하트 구매/대기)                            │
│      └── RewardModal (보상 수령)                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 씬 목록 및 계층

### 2.1 전체 씬 목록 (MVP)

| ID | 씬 이름 | 타입 | 우선순위 | 예상 개발 시간 |
|----|---------|------|----------|----------------|
| S01 | SplashScene | 루트 | P0 | 0.5일 |
| S02 | TutorialPuzzleScene | 온보딩 | P0 | 2일 |
| S03 | TutorialCafeScene | 온보딩 | P0 | 1.5일 |
| S04 | CafeScene | 메인 | P0 | 5일 |
| S05 | MapScene | 메인 | P0 | 3일 |
| S06 | PuzzlePreScene | 퍼즐 | P0 | 1일 |
| S07 | PuzzleScene | 퍼즐 | P0 | 10일 ★ |
| S08 | PuzzleResultScene | 퍼즐 | P0 | 2일 |
| S09 | DecorationScene | 카페 | P0 | 4일 |
| S10 | StoryScene | 카페 | P0 | 3일 |
| S11 | ShopScene | 카페 | P1 | 2일 |
| S12 | BoosterSelectModal | 모달 | P0 | 1.5일 |
| S13 | HeartModal | 모달 | P0 | 1일 |
| S14 | SettingsModal | 모달 | P1 | 1일 |
| S15 | RewardModal | 모달 | P1 | 1일 |

**총 개발 시간**: ~39 인일

### 2.2 씬 계층 다이어그램

```
AppRoot
  │
  ├─ SplashScene
  │    └─> TutorialPuzzleScene (신규)
  │    └─> MainTabContainer (복귀)
  │
  ├─ TutorialPuzzleScene
  │    └─> TutorialCafeScene
  │         └─> MainTabContainer
  │
  └─ MainTabContainer
       │
       ├─ Tab1: CafeScene (카페)
       │    ├─> DecorationScene (인테리어 모드)
       │    ├─> StoryScene (단골 대화)
       │    └─> ShopScene (상점)
       │
       └─ Tab2: MapScene (스테이지)
            └─> PuzzlePreScene (스테이지 선택)
                 └─> PuzzleScene (게임플레이)
                      ├─> BoosterSelectModal (부스터)
                      ├─> HeartModal (하트 부족 시)
                      └─> PuzzleResultScene (결과)
                           └─> (MapScene 복귀)

       [공통 모달]
       ├─> SettingsModal
       ├─> RewardModal
       └─> HeartModal
```

---

## 3. 씬 전환 플로우

### 3.1 앱 시작 플로우

```
[앱 실행]
    │
    v
SplashScene (2초)
    │
    v
<저장 데이터 확인>
    │
    ├─ [신규] ─────> TutorialPuzzleScene
    │                     │
    │                     v
    │                TutorialCafeScene
    │                     │
    │                     v
    └─ [복귀] ─────> MainTabContainer
                          │
                          v
                     CafeScene (기본 탭)
                          │
                          v
                    <하트 회복 확인>
                          │
                          v
                    <정상 플레이>
```

### 3.2 메인 게임 루프 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                    메인 게임 루프                                │
└─────────────────────────────────────────────────────────────────┘

CafeScene (카페 감상)
    │
    │ 하단 탭 "스테이지"
    v
MapScene (스테이지 맵)
    │
    │ 스테이지 선택
    v
PuzzlePreScene (미리보기)
    │
    │ "플레이" 버튼
    v
<하트 확인>
    │
    ├─ [부족] ─> HeartModal
    │                │
    │                ├─ [대기] ─> (MapScene 복귀)
    │                └─ [구매] ─> PuzzleScene
    │
    └─ [충분] ─> PuzzleScene (게임 시작)
                      │
                      v
                 <플레이 진행>
                      │
                      v
                 <결과 판정>
                      │
                      ├─ [클리어] ─> PuzzleResultScene (승리)
                      │                   │
                      │                   v
                      │              <보상 지급>
                      │              (별, 코인)
                      │                   │
                      │                   v
                      │              MapScene (다음 스테이지 해금)
                      │
                      └─ [실패] ─> PuzzleResultScene (패배)
                                        │
                                        v
                                   <재시도 선택>
                                        │
                                        ├─ [재시도] ─> PuzzleScene
                                        └─ [포기] ─> MapScene
```

### 3.3 카페 인테리어 플로우

```
CafeScene
    │
    │ "꾸미기" 버튼
    v
DecorationScene (인테리어 모드)
    │
    │ <현재 카페 표시>
    v
[가구 목록 UI]
    │
    │ 가구 선택
    v
<배치 모드>
    │
    ├─ 드래그 & 드롭으로 위치 조정
    ├─ 회전/크기 조정 (일부 가구)
    └─ [배치 완료]
         │
         v
    <코인 차감>
         │
         v
    <카페 갱신>
         │
         v
    (CafeScene 복귀, 새 가구 배치됨)
         │
         v
    <단골 반응> (StoryScene 트리거)
```

---

## 4. 씬별 상세 구성

### S04: CafeScene (카페 메인)

#### 4.4.1 목적
- 플레이어의 카페 감상
- 인테리어 결과물 시각화
- 단골 캐릭터와 상호작용
- 메타 진행 현황 확인

#### 4.4.2 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [☰]  카페 매치 타이쿤             [💰 2,450]  [⭐ 8]  [⚙️]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    [카페 내부 일러스트]                         │
│                   (플레이어가 꾸민 인테리어)                     │
│                                                                 │
│        ☕ [테이블] [의자] [장식품] ...                          │
│                                                                 │
│                                                                 │
│        🙎‍♀️ [단골 엘리]                                          │
│      "새 소파 너무 예쁘네요!" ← 탭하여 대화                      │
│                                                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 📋 오늘의 할 일                                          │  │
│  │ • 스테이지 5 클리어 (0/1) ⭐                             │  │
│  │ • 단골 3명과 대화 (1/3) 💬                              │  │
│  │ • 가구 1개 배치 (0/1) 🪑                                │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 🎁 보상 대기 중                                          │  │
│  │ • 스테이지 4 클리어 보상 [수령]                          │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ [🪑 꾸미기]  [💬 단골]  [🛒 상점]                        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  [☕ 카페]  [🗺️ 스테이지]                                      │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.4.3 구성 요소

| 요소 | 기능 | 인터랙션 |
|------|------|----------|
| 카페 배경 | 플레이어가 꾸민 인테리어 표시 | 패럴랙스 스크롤, 줌 인/아웃 |
| 가구 오브젝트 | 배치된 가구 시각화 | 탭하여 정보, 길게 눌러 이동 |
| 단골 NPC | 스토리 캐릭터 표시 | 탭→StoryScene |
| 할 일 목록 | 일일/주간 미션 | 탭하여 상세, 완료 시 보상 |
| 꾸미기 버튼 | 인테리어 모드 진입 | →DecorationScene |
| 단골 버튼 | 단골 목록 | →단골 선택→StoryScene |
| 상점 버튼 | 가구/아이템 구매 | →ShopScene |

#### 4.4.4 카페 레이아웃 시스템

```
[카페 공간]
├── 그리드 시스템 (10x10 타일)
├── 배치 가능 영역 표시
├── 레이어 구조
│   ├── 배경 (벽지, 바닥)
│   ├── 가구 (테이블, 의자, 선반)
│   ├── 장식 (그림, 화분, 조명)
│   └── NPC (단골 캐릭터)
└── 줌 레벨
    ├── 기본: 카페 전체 보기
    └── 확대: 가구 디테일 보기
```

---

### S05: MapScene (스테이지 맵)

#### 4.5.1 목적
- 스테이지 선택
- 진행도 시각화
- 다음 목표 제시

#### 4.5.2 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [☰]  스테이지                     [💰 2,450]  [⭐ 8]  [❤️ 5]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    [맵 배경 일러스트]                           │
│                   (카페 주변 마을 지도)                         │
│                                                                 │
│                                                                 │
│                        [1] ✅                                   │
│                         ↓                                      │
│                        [2] ✅                                   │
│                         ↓                                      │
│                        [3] ✅ ⭐⭐⭐                             │
│                         ↓                                      │
│                        [4] ✅ ⭐⭐                               │
│                         ↓                                      │
│                        [5] 🔓 ← 현재 도전 가능                  │
│                         ↓                                      │
│                        [6] 🔒                                   │
│                         ↓                                      │
│                       ...                                      │
│                                                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 스테이지 5: "모닝 러시"                                   │  │
│  │                                                          │  │
│  │ 목표: 커피잔 20개 수집                                    │  │
│  │ 턴 수: 25턴                                               │  │
│  │ 난이도: ★★☆☆☆                                           │  │
│  │                                                          │  │
│  │ [플레이하기] (❤️ 1 소모)                                  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  [☕ 카페]  [🗺️ 스테이지]                                      │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.5.3 스테이지 아이콘 상태

| 상태 | 아이콘 | 의미 |
|------|--------|------|
| ✅ ⭐⭐⭐ | 초록 체크 + 별 3개 | 완벽 클리어 |
| ✅ ⭐⭐ | 초록 체크 + 별 2개 | 클리어 (목표 미달성) |
| ✅ ⭐ | 초록 체크 + 별 1개 | 클리어 (최소 목표만) |
| 🔓 | 열린 자물쇠 | 도전 가능 |
| 🔒 | 잠긴 자물쇠 | 잠김 (이전 스테이지 클리어 필요) |

#### 4.5.4 맵 스크롤 & 줌

```
[스크롤]
├── 세로 스크롤 (스테이지 1 ~ 현재 +5)
├── 부드러운 스냅 (스테이지 중심)
└── 현재 스테이지로 자동 포커스

[줌]
├── 핀치 투 줌 지원
├── 줌 아웃: 맵 전체 보기
└── 줌 인: 스테이지 상세 정보
```

---

### S07: PuzzleScene (Match-3 게임플레이) ★ 핵심

#### 4.7.1 목적
- Match-3 퍼즐 게임플레이
- 스테이지 목표 달성
- 부스터 사용

#### 4.7.2 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [←]  스테이지 5: "모닝 러시"                          [⚙️]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │ 목표:      │  │ 턴 수:     │  │ 점수:      │               │
│  │ ☕ 20/20   │  │ 15 / 25    │  │ 3,250      │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│                  [Match-3 게임 보드]                            │
│                       8 x 8 그리드                              │
│                                                                 │
│     ☕ 🍰 🥐 ☕ 🧁 🍰 ☕ 🥐                                      │
│     🍰 ☕ 🧁 🥐 ☕ 🍰 🧁 ☕                                      │
│     🥐 🧁 ☕ 🍰 🧁 🥐 ☕ 🍰                                      │
│     ☕ 🍰 🧁 ☕ 🥐 ☕ 🧁 🥐                                      │
│     🧁 ☕ 🥐 🍰 ☕ 🧁 🍰 ☕                                      │
│     🍰 🥐 ☕ 🧁 🍰 ☕ 🥐 🧁                                      │
│     ☕ 🧁 🍰 ☕ 🥐 🧁 ☕ 🍰                                      │
│     🥐 ☕ 🧁 🍰 ☕ 🥐 🍰 ☕                                      │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                       │
│  │ 🔨   │  │ 🌀   │  │ +5   │  │ 💣   │                       │
│  │ 망치  │  │ 셔플  │  │ 턴   │  │ 폭탄  │                       │
│  │ × 3  │  │ × 1  │  │ × 2  │  │ × 0  │                       │
│  └──────┘  └──────┘  └──────┘  └──────┘                       │
│                   [부스터 사용]                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.7.3 게임 보드 구성

```
[보드 사양]
├── 크기: 8 x 8 (MVP 기본)
├── 타일 종류: 5가지 (커피, 케이크, 크루아상, 컵케이크, 쿠키)
├── 특수 타일:
│   ├── 줄무늬 타일 (4개 매치)
│   ├── 포장 타일 (5개 매치 L자)
│   └── 폭탄 타일 (5개 매치 일직선)
└── 장애물:
    ├── 상자 (1-2회 타격 필요)
    ├── 돌 (파괴 불가)
    └── 얼음 (매치 시 녹음)
```

#### 4.7.4 게임플레이 플로우

```
[게임 시작]
    │
    v
<보드 생성 & 초기화>
    │
    v
[플레이어 턴]
    │
    ├─ 타일 스왑 선택 (드래그 또는 탭×2)
    │   │
    │   v
    │ <매치 검증>
    │   │
    │   ├─ [유효 매치] ─> 타일 제거 애니메이션
    │   │                    │
    │   │                    v
    │   │               <중력 적용>
    │   │                    │
    │   │                    v
    │   │               <새 타일 생성>
    │   │                    │
    │   │                    v
    │   │               <연쇄 매치 확인>
    │   │                    │
    │   │                    v
    │   │               (점수/목표 갱신)
    │   │
    │   └─ [무효 매치] ─> 타일 원위치 애니메이션
    │
    v
<턴 감소>
    │
    v
<목표 달성 확인>
    │
    ├─ [달성] ─> PuzzleResultScene (승리)
    │
    └─ [미달성] ─> <턴 수 확인>
                      │
                      ├─ [턴 남음] ─> (플레이어 턴 반복)
                      │
                      └─ [턴 0] ─> PuzzleResultScene (패배)
```

#### 4.7.5 매치 애니메이션 타임라인

```
[3개 매치 애니메이션]
0.0s: 타일 선택 (강조 효과)
0.1s: 스왑 애니메이션 시작
0.3s: 스왑 완료
0.4s: 매치 확인 (타일 깜빡임)
0.5s: 타일 파괴 (폭발 파티클)
0.7s: 점수 텍스트 "+100" 표시
0.8s: 상단 타일 낙하 시작 (중력)
1.2s: 새 타일 생성
1.4s: 연쇄 매치 확인
1.5s: (연쇄 시 0.4s부터 반복)
```

---

### S08: PuzzleResultScene (결과)

#### 4.8.1 승리 화면

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                    🎉 스테이지 클리어! 🎉                       │
│                                                                 │
│                                                                 │
│                  ┌─────────────────┐                           │
│                  │                 │                           │
│                  │   ⭐ ⭐ ⭐      │                           │
│                  │                 │                           │
│                  │   3,250 점      │                           │
│                  │                 │                           │
│                  └─────────────────┘                           │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│  🎁 보상                                                        │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  💰 +500 코인                                                   │
│  ⭐ +3 별                                                       │
│  🔨 +1 망치 부스터                                              │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│  📊 목표 달성                                                   │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  ✅ ☕ 커피 20개 수집 (20/20)                                   │
│  ✅ 🍰 케이크 15개 수집 (18/15) +보너스!                        │
│  ✅ 3,000점 이상 (3,250)                                        │
│                                                                 │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                  [다음 스테이지]                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  [맵으로 돌아가기]                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.8.2 패배 화면

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                      😢 아쉬워요!                               │
│                                                                 │
│                                                                 │
│                  "조금만 더 하면 될 것 같아요"                   │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│  📊 달성 현황                                                   │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  ❌ ☕ 커피 18/20 (90%)                                         │
│  ✅ 🍰 케이크 15/15 (100%)                                      │
│                                                                 │
│  남은 턴: 0                                                     │
│  획득 점수: 2,850                                               │
│                                                                 │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         [재도전] (❤️ 1)                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         [+5턴으로 계속하기] (💎 50)                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  [포기하고 맵으로]                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### S09: DecorationScene (인테리어)

#### 4.9.1 목적
- 카페 꾸미기
- 가구 배치
- 창작의 자유 제공

#### 4.9.2 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [✓ 완료]  카페 꾸미기                        [💰 2,450]  [⚙️] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                  [카페 편집 뷰]                                 │
│             (그리드 가이드 표시)                                │
│                                                                 │
│        ┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐                              │
│        │ │ │ │☕│☕│ │ │ │ │ │                              │
│        ├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤                              │
│        │ │ │🪑│🪑│🪑│ │ │ │ │ │                              │
│        ├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤                              │
│        │ │ │ │ │ │ │🌸│ │ │ │  ← 드래그로 이동              │
│        ├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤                              │
│        │ │📚│📚│ │ │ │ │ │ │ │                              │
│        └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘                              │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│  🪑 가구 목록                                                   │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  [가구] [장식] [조명] [배경]  ← 카테고리 탭                     │
│                                                                 │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐            │
│  │ ☕   │  │ 🪑   │  │ 📚   │  │ 🌸   │  │ 🪴   │            │
│  │테이블 │  │ 의자  │  │ 책장  │  │ 화분  │  │ 조명  │            │
│  │ 200💰│  │ 50💰 │  │ 300💰│  │ 80💰 │  │ 150💰│            │
│  │ [배치]│  │ [배치]│  │ [배치]│  │ 🔒  │  │ [배치]│            │
│  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘            │
│                                                                 │
│  ... (스크롤)                                                   │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│  선택된 가구: 책장                                              │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│  [회전]  [복사]  [삭제]                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.9.3 배치 인터랙션

```
[배치 모드]
1. 가구 목록에서 선택
   │
   v
2. 카페 뷰에 반투명 프리뷰 표시
   │
   v
3. 드래그로 위치 이동
   │
   ├─ [유효 위치] → 초록 테두리
   └─ [무효 위치] → 빨강 테두리 (다른 가구와 겹침)
   │
   v
4. 손가락 떼기 → 배치 확정
   │
   v
5. <코인 차감>
   │
   v
6. 가구 목록에서 "배치됨" 표시

[편집 모드]
1. 배치된 가구 탭
   │
   v
2. 가구 선택 (강조 테두리)
   │
   v
3. 하단 툴바 표시
   │
   ├─ [회전] → 90도 회전
   ├─ [복사] → 같은 가구 추가 배치 (코인 재소비)
   └─ [삭제] → 가구 제거 (코인 환불 50%)
```

---

### S10: StoryScene (단골 대화)

#### 4.10.1 목적
- 스토리텔링
- 캐릭터 친밀도
- 몰입감 향상

#### 4.10.2 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [←]  엘리와의 대화                                    [건너뛰기]│
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                                                                 │
│                  [단골 엘리 초상화]                             │
│                   (감정 표현 변화)                              │
│                                                                 │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  엘리                                                     │ │
│  │  "어머, 새로 들어온 소파 정말 편해 보이네요!              │ │
│  │   앉아봐도 될까요?"                                       │ │
│  │                                                           │ │
│  │                                         [다음] ──────────>│ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│                                                                 │
│                    ●●●○○                                      │
│                 (대화 진행도)                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.10.3 대화 시스템

```
[대화 데이터 구조]
{
  "storyId": "eli_001",
  "characterId": "eli",
  "trigger": "furniture_sofa_placed",
  "dialogues": [
    {
      "speaker": "eli",
      "text": "어머, 새로 들어온 소파 정말 편해 보이네요!",
      "emotion": "happy"
    },
    {
      "speaker": "eli",
      "text": "앉아봐도 될까요?",
      "emotion": "curious"
    },
    {
      "speaker": "player",
      "choices": [
        {"text": "물론이죠!", "next": 3},
        {"text": "나중에요", "next": 5}
      ]
    },
    {
      "speaker": "eli",
      "text": "감사해요! 정말 푹신해요~",
      "emotion": "love",
      "reward": {"intimacy": 10, "coins": 50}
    }
  ]
}
```

#### 4.10.4 대화 플로우

```
[대화 시작]
    │
    v
<캐릭터 등장 애니메이션>
    │
    v
[대화 텍스트 표시]
    │
    ├─ 타이핑 효과 (한 글자씩)
    ├─ 캐릭터 감정 변화
    └─ 배경음악/효과음
    │
    v
<플레이어 입력 대기>
    │
    ├─ [탭/다음] → 다음 대사
    ├─ [선택지] → 분기 처리
    └─ [건너뛰기] → 대화 종료 (보상 없음)
    │
    v
<대화 완료>
    │
    v
[보상 연출]
    │
    ├─ 친밀도 +10
    ├─ 코인 +50
    └─ "엘리가 기뻐합니다!" 메시지
    │
    v
(CafeScene 복귀)
```

---

## 5. Match-3 퍼즐 메커니즘

### 5.1 Match-3 엔진 설계

#### 5.1.1 보드 관리

```dart
// mg-common-game/lib/systems/match3/match3_board.dart

class Match3Board {
  final int rows = 8;
  final int cols = 8;
  late List<List<Tile?>> grid;

  // 보드 초기화
  void initialize() {
    grid = List.generate(
      rows,
      (row) => List.generate(
        cols,
        (col) => _generateRandomTile(row, col),
      ),
    );
    // 초기 보드에 매치 없도록 보장
    _ensureNoInitialMatches();
  }

  // 타일 스왑
  bool swapTiles(Position pos1, Position pos2) {
    // 인접 확인
    if (!_isAdjacent(pos1, pos2)) return false;

    // 스왑
    final temp = grid[pos1.row][pos1.col];
    grid[pos1.row][pos1.col] = grid[pos2.row][pos2.col];
    grid[pos2.row][pos2.col] = temp;

    // 매치 검증
    List<Match> matches = findMatches();
    if (matches.isEmpty) {
      // 무효 스왑, 원복
      swapTiles(pos2, pos1);
      return false;
    }

    return true;
  }

  // 매치 찾기
  List<Match> findMatches() {
    List<Match> matches = [];

    // 가로 매치 검사
    for (int row = 0; row < rows; row++) {
      for (int col = 0; col < cols - 2; col++) {
        final match = _checkHorizontalMatch(row, col);
        if (match != null) matches.add(match);
      }
    }

    // 세로 매치 검사
    for (int col = 0; col < cols; col++) {
      for (int row = 0; row < rows - 2; row++) {
        final match = _checkVerticalMatch(row, col);
        if (match != null) matches.add(match);
      }
    }

    return matches;
  }

  // 중력 적용
  void applyGravity() {
    for (int col = 0; col < cols; col++) {
      int emptyRow = rows - 1;
      for (int row = rows - 1; row >= 0; row--) {
        if (grid[row][col] != null) {
          if (row != emptyRow) {
            grid[emptyRow][col] = grid[row][col];
            grid[row][col] = null;
          }
          emptyRow--;
        }
      }
    }
  }

  // 새 타일 생성
  void fillEmptyCells() {
    for (int col = 0; col < cols; col++) {
      for (int row = 0; row < rows; row++) {
        if (grid[row][col] == null) {
          grid[row][col] = _generateRandomTile(row, col);
        }
      }
    }
  }
}
```

### 5.2 특수 타일 생성

```
[4개 매치] → 줄무늬 타일
├── 가로 4개 → 가로 줄무늬 (세로 한 줄 제거)
└── 세로 4개 → 세로 줄무늬 (가로 한 줄 제거)

[5개 매치 L/T자] → 포장 타일
└── 폭발 시 주변 3x3 제거

[5개 매치 일직선] → 폭탄 타일
└── 폭발 시 같은 색상 모두 제거

[특수타일 + 특수타일 조합]
├── 줄무늬 + 줄무늬 → 십자 폭발
├── 줄무늬 + 포장 → 3줄 제거
├── 포장 + 포장 → 5x5 폭발
└── 폭탄 + 모든 특수 → 보드 전체 색상 변환
```

### 5.3 부스터 시스템

| 부스터 | 효과 | 사용 방법 | 획득 |
|--------|------|-----------|------|
| 🔨 망치 | 타일 1개 제거 | 타일 탭 | 스테이지 보상, 상점 |
| 🌀 셔플 | 보드 재배치 | 버튼 클릭 | 스테이지 보상, 상점 |
| +5턴 | 턴 5개 추가 | 버튼 클릭 | 광고 시청, 상점 |
| 💣 폭탄 | 3x3 폭발 | 위치 탭 | 상점 (프리미엄) |

---

## 6. 카페 인테리어 시스템

### 6.1 가구 카테고리

| 카테고리 | 종류 | MVP 수량 | 예시 |
|----------|------|----------|------|
| 테이블 | 필수 가구 | 5종 | 원형 테이블, 사각 테이블, 빈티지 테이블 |
| 의자 | 필수 가구 | 5종 | 원목 의자, 소파, 스툴 |
| 진열대 | 장식 가구 | 4종 | 책장, 진열장, 선반 |
| 조명 | 분위기 | 3종 | 펜던트, 스탠드, 샹들리에 |
| 화분 | 장식 | 4종 | 화분, 꽃병, 관엽식물 |
| 벽 장식 | 장식 | 4종 | 그림, 거울, 시계 |
| 바닥재 | 배경 | 3종 | 원목, 타일, 카펫 |
| 벽지 | 배경 | 3종 | 무지, 패턴, 벽돌 |

**총 31종 가구**

### 6.2 가구 배치 규칙

```
[그리드 시스템]
├── 10x10 타일 (각 타일 64x64 px)
├── 가구 크기: 1x1, 2x1, 2x2, 3x2 등
└── 스냅 기능 (자동 정렬)

[배치 제약]
├── 겹침 방지 (같은 레이어)
├── 출입구 확보 (필수 동선)
├── 레이어 순서 (배경 < 가구 < 장식 < NPC)
└── 용량 제한 (최대 50개 가구, 업그레이드 가능)

[자동 배치]
└── "추천 배치" 버튼 → AI가 자동 배치 (테마별)
```

### 6.3 단골 시스템

| 단골 이름 | 등장 조건 | 선호 아이템 | 스토리 라인 |
|-----------|-----------|-------------|-------------|
| 엘리 | 스테이지 1 클리어 | 소파, 책 | 작가 지망생, 카페에서 영감 |
| 톰 | 스테이지 5 클리어 | 커피 머신, 빈티지 가구 | 단골 할아버지, 추억 이야기 |
| 루나 | 스테이지 10 클리어 | 화분, 자연 조명 | 식물 애호가, 힐링 추구 |

**총 8명 (MVP: 3명)**

---

## 7. 부록

### 7.1 씬 개발 우선순위

```
[1차: 핵심 플레이 (Week 1-6)]
├── S07: PuzzleScene (Match-3 엔진)
├── S06: PuzzlePreScene
├── S08: PuzzleResultScene
└── S05: MapScene

[2차: 메타 게임 (Week 7-10)]
├── S04: CafeScene
├── S09: DecorationScene
├── S10: StoryScene
└── S11: ShopScene

[3차: 온보딩 & 폴리싱 (Week 11-12)]
├── S01: SplashScene
├── S02-03: Tutorial
└── S12-15: Modals
```

### 7.2 성능 최적화

```
[Match-3 엔진 최적화]
├── Object Pooling (타일 재사용)
├── 애니메이션 배치 처리 (한 프레임에 모든 매치)
├── 연쇄 계산 미리 처리
└── 60 FPS 보장 (모바일 저사양)

[카페 렌더링]
├── 가구 레이어 캐싱
├── 패럴랙스 최적화
└── 오프스크린 가구 컬링
```

### 7.3 데이터 구조

```json
{
  "player": {
    "coins": 2450,
    "stars": 8,
    "hearts": 5,
    "level": 5,
    "cafe": {
      "furniture": [
        {"id": "table_01", "x": 3, "y": 2, "rotation": 0},
        {"id": "chair_02", "x": 2, "y": 3, "rotation": 90}
      ],
      "wallpaper": "wood_01",
      "floor": "tile_02"
    },
    "progress": {
      "currentStage": 5,
      "stageStars": {
        "1": 3,
        "2": 3,
        "3": 2,
        "4": 2,
        "5": 0
      }
    },
    "regulars": [
      {
        "id": "eli",
        "intimacy": 50,
        "unlocked": true,
        "storyProgress": 3
      }
    ]
  }
}
```

---

**END OF DOCUMENT**

다음: MG-0025 NEON COVERT 씬 구조 문서 작성
